<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Social media</title>
</head>

<body>
     <div id="message"></div>
     <div id="users"></div>
     <div id="posts"></div>
     <div id="others-posts"></div>
     <form action="" id="create-post">
          <input type="file" id="attachments" multiple>
          <textarea name="" id="content" cols="30" rows="10"></textarea>
          <button type="submit"> Create Post </button>
     </form>

     <form id='comment-form'>
          <div id='post-id'></div>
          <input id='comment'>
          <button type="submit"> Post Comment </button>
     </form>

     <section style="border:1px solid black" id='post_info'>
          </style>

</body>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.js"
     integrity="sha512-pmaEGtUAy7E5gRmwjLqQAD/QWw0dL4Z59b6b+2HQkqQwQ+HcPLLb9/KbUNo5zr10WuXmbivK9nYVZOyDkMgZMg=="
     crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script src="axios.js"></script>
<script src='postScripts.js'></script>
<script src="createPost.js"></script>
<script>
     attachments = document.getElementById('attachments')


     document.getElementById('create-post').addEventListener('submit', async (e) => {
          e.preventDefault()
          content = document.getElementById('content').value
          console.log(attachments)
          readAndUploadChunk(attachments)
          // const createPost = await axios.post("/api/v1/posts", { content });
          // console.log(createPost.data)
     })

     chunkSize = 4 * 2048;
     from = 0;
     to = chunkSize;
     function readAndUploadChunk(attachments) {
          let file_selected = attachments.files[0]
          if (file_selected.type != "image/png" && file_selected.type != "image/jpg" &&
               file_selected.type != "image/jpeg" && file_selected.type != "image/gif" &&
               file_selected.type != "video/mp4") {
               alert("File type selected not supported" + file_selected.type)
               return
          } else if (file_selected.size > (5 * 1024 * 1024)) {
               alert("Maximum file size is 5MB")
               return
          } else {

               let fileReader = new FileReader()

               fileReader.readAsDataURL(file_selected)

               fileReader.onload = async (e) => {
                    uploadChunk(e.target.result, file_selected)
               }

          }
     }

     const uploadChunk = async (fileBuffer, file_selected) => {
          curr_buff = fileBuffer.slice(from, to)
          const params = new URLSearchParams();
          params.set('filename', file_selected.name)
          const uploadFile = await axios.post("/api/v1/upload?" + params.toString(), { file: curr_buff });
          if (uploadFile.data.success && to < file_selected.size) {
               from = to
               to = from + chunkSize
               if (to > file_selected.size) to = file_selected.size
               // file_selected.size > (to + (4 * 2048)) ? to + (4 * 2048) : file_selected.size
               uploadChunk(fileBuffer, file_selected)
          }
     }
</script>

</html>